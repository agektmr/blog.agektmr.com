---
layout: post
title: 'パスワードのない世界に向けて'
description: ''
date: 2022-06-06
image:
  feature: /2022/key.jpg
tags:
- WebAuthn
- FIDO
- FedCM
- WebOTP
- Passkeys
- Identity
---

先日 Google I/O で ["A path to a world without passwords"](https://io.google/2022/program/e3bb37a4-2723-4d72-a5b3-1a23abb94ac0/) というセッションを担当しました。

{% YouTube '6vnQDn3AUbo' %}

この記事はそのセッションの内容を元に、パスワードのない世界の実現に向けて、今後どんなことが可能になるのか、それに対してウェブ開発者は何をすべきか、をまとめて再構成したものです。長いので先に記事の内容をまとめると以下のものになります:

* パスワードだけを使った認証ではユーザーを守りきれない世界になってきている。二段階認証は複雑な上、穴も多い。
* WebAuthn を使うことで、より安全かつシンプルでスムーズなログイン体験を提供することができる。
* Passkeys が使えるようになれば、多くのウェブサイトでパスワードをなくす未来が見えてきた。
* とはいえ移行の間、パスワードは残さざるを得ない。二段階認証でセキュリティを高めるべき。
* ID 連携もすぐに実現できるパスワードレス。今後 Federated Credential Management API がプライバシーも改善してくれるかもしれない。

<!-- excerpt -->

## なぜパスワードをなくす方がよいのか

ウェブでは、ユーザー名とパスワードを使った認証方法が長らく使われてきました。しかし、2022 年現在、パスワードにまつわる問題はあとを絶ちません。パスワードを使っているがためにアカウントを乗っ取られてしまった経験のある方も多いのではないでしょうか？最近のアカウント乗っ取りは単なるいたずらに留まらず、金銭的被害も伴います。

アカウントの乗っ取りは、システムの脆弱性に付け込んだものだけでなく、ユーザーの扱い方に端を発したものも多くあります。例えばパスワードを推測しやすいものにしてしまったり、複数サイトに跨って同じパスワードを使いまわしてしまうことで、簡単に盗まれてしまうことが知られています。理想的には各サイトごとに異なる複雑なパスワードを使うべきですが、現実的には難しいと言わざるを得ません。

仮にサイトごとに異なる複雑なパスワードを使っていたとしても、誤ってドメインの異なるサイトにそれを入力してしまうと、アカウントは乗っ取られたも同然です。これをフィッシングと呼び、SMS や広告などから積極的にフィッシングサイトに誘導する攻撃方法は拡大を続けています。最近は手口がさらに巧妙になっているため、自分は大丈夫と思っても気を付ける必要があります。

{% Figure '/images/2022/phishing-is-surging.png', '', 'source: <a href="https://blog.google/intl/en-in/products/platforms/better-password-protections-in-chrome/">https://blog.google/intl/en-in/products/platforms/better-password-protections-in-chrome</a>' %}

パスワードマネージャーはそんな時に強力な補助機能を提供してくれます。**正しいドメインでのみ**パスワードを自動入力してくれる機能や同期機能だけでなく、強いパスワードを自動生成したり、脆弱なパスワードを警告、さらには強力なパスワードに自動更新したりもしてくれます。殆どのブラウザがパスワードマネージャー機能を提供していますし、単独のパスワードマネージャーアプリも存在します。ブラウザ拡張や OS の補助機能を使うことで、ブラウザのパスワードマネージャーと同等に使えるものも少なくありません。

ユーザーとしてパスワードマネージャーを使うことは、安全なインターネットライフを過ごす手助けとなるため断然おすすめします。しかし、ある程度のリテラシが要求されるため、すべてのユーザーが使ってくれるわけではありません。ましてやサービス提供者として顧客となるユーザーの安全性を保つとなると、話は全く変わってきます。ユーザーにパスワードマネージャーの利用を強制することはできませんし、パスワードを認証手段として使い続けている限り、セキュリティの問題とユーザビリティの問題が一定のラインより良くなることはないと言わざるを得ません。

それなら、そもそもパスワードを使わずに安全かつ快適にユーザーアカウントを管理する方法はないのでしょうか？

## 切り札となる WebAuthn

以前、[パスワードの不要な世界はいかにして実現されるのか](/2019/03/fido-webauthn.html)という記事を書いたので少し内容が重複しますが、重要な部分に絞って改めて書きます。

WebAuthn は[すべてのメジャーブラウザがサポートする](https://caniuse.com/webauthn)比較的新しいウェブ標準で、ハードウェアベースの公開鍵暗号方式を使い、フィッシングに強い認証を実現します。その仕様は [FIDO Alliance](https://fidoalliance.org/) が中心となり、FIDO2 という枠組みの中で規定されています。

FIDO2 では他にも、セキュリティキーなどの「認証器」と呼ばれるハードウェアデバイスの要件に加え、CTAP2 というクライアントと認証器の通信プロトコルについても規定しています。ブラウザが認証器と通信するための JavaScript API が [WebAuthn](https://webauthn.guide) であり、現在も [W3C で活発に仕様が議論](https://github.com/w3c/webauthn)されています。

{% Figure '/images/2022/security-keys.png', '', 'セキュリティキー' %}

### セキュリティキーの使い方

WebAuthn で認証を行うにはサイトごとに事前に登録が必要です。WebAuthn で登録を行おうとすると、USB などでコンピューターに接続されたセキュリティキーが光るので、これをタッチします。これを「セレモニー」といい、物理的な操作を要することでソフトウェアベースの攻撃を防ぎ、所有認証をより確実なものにします。セレモニーを行うと、セキュリティキーは公開鍵暗号ペアが生成し、秘密鍵はオリジンの情報と合わせて、取り出せない形で安全に認証器内に保管され、公開鍵がクライアント (この場合ブラウザ) に返されます。クライアントは公開鍵をサーバーに保存しておきます。

認証時も同様にして、セレモニーが要求されます。セレモニーが成功すると保管されていた秘密鍵を使って署名が発行されるため、サーバーでの検証が成功すれば認証完了、ということになります。ポイントはこの際、オリジンがチェックされるという点です。秘密鍵は予めオリジンと紐付けられているため、仮にユーザーが悪意のあるウェブサイトに誘導されたとしても、認証器が署名を発行しないためフィッシングは失敗に終わります。実際、Google のレポート上ではフィッシング耐性 100% だった、という報告があります。

{% Figure '/images/2022/phishing-resistant.png', '', 'source: <a href="https://security.googleblog.com/2019/05/new-research-how-effective-is-basic.html">https://security.googleblog.com/2019/05/new-research-how-effective-is-basic.html</a>' %}

もちろん、セキュリティキーが証明できるのは、その認証器がログインしようとしているユーザーの手元にあるらしい (所有認証)、ということだけなので、これをパスワードなどの知識認証と合わせることでより強力なログイン機能とすることができます。これが二段階・二要素認証です。

### プラットフォーム認証器

セキュリティキーでフィッシングに強い認証が実現できることは分かりましたが、じゃあユーザーにひとつ数千円するセキュリティキーを持ってもらおう、というのはあまり現実的ではない話です。また、ログイン手順も多い上にパスワードも必要なままです。そこで登場するのが**プラットフォーム認証器**です。プラットフォーム認証器はスマートフォンやコンピューターに埋め込まれたセキュリティチップを認証器として活用したもので、対応したデバイスは多くの場合、生体認証の機能も合わせて持っています。

プラットフォーム認証器が画期的なのは、セキュリティキーを新たに購入しなくてもよいだけなく、この生体認証を含めたデバイスのアンロック機能をセレモニーとすることで、所有認証に加え、生体認証 (もしくは知識認証) の二要素が一度に認証できることにあります。つまり、一段回・二要素認証です。

「生体認証」と言えればひとことで済むので楽なのですが、実際は生体認証を含めたアンロック機能です。例えば指紋認証の場合、指が乾燥していたり怪我したりといった理由で使えなくなる場面は少なくないため、PIN やパターンを使った知識認証が役に立ちます。これは Android に限った話ではなく、macOS や iOS でも同様です。また、生体認証が使えない端末でも PIN やパターンがあればプラットフォーム認証器として使える、というメリットもあります。

知識認証だったらパスワードと変わらないから危ないのでは？と思いましたか？そんなことはありません。決定的に違うのは、PIN やパターンで認証するには、そのデバイスが手元になければならないという点です。プラットフォーム認証器を使った認証が「ローカル認証」と呼ばれるのはそのためです。また、PIN やパターンは少なくとも指紋認証よりは安全と考えられています。Android でも iOS では試行回数が制限されていますし、変更することもできます。

「ローカル認証」は生体認証にも当てはまります。FIDO の規定では認証する際の生体情報はネットワークに送られないため、例えば指紋情報がサーバーに保存されることもありません。また、生体認証の方法は抽象化されているため、指紋認証や顔認証に限定されず、柔軟に対応可能です。将来的にさらに安全性の高い新しい方式が出てくれば、それが利用可能になるはずです。

プラットフォーム認証器はすでに身近なところで使われています。先日公開した [Yahoo! JAPAN のパスワードレスの取り組みに関する記事](https://web.dev/i18n/ja/yahoo-japan-identity-case-study/)では、電話番号と SMS OTP を使ったログイン方法を主とし、同じデバイスであれば FIDO を使って再認証できる、という体験が紹介されています。PayPal や Google などでも部分的に利用されています。

なお、簡易的な再認証のデモは[ここ](https://webauthn-codelab.glitch.me/)で試すことができます。実際に試してみると、パスワードや SMS を使った認証方法と比較して、セキュリティとユーザビリティのバランスがよくできた認証方法だと気付くかと思います。これを実装する体験ができる[コードラボ](https://developers.google.com/codelabs/webauthn-reauth)もありますので、興味ある方はぜひお試しください (ビデオはイベント用にあとから補助的に作ったものなので、なくてもコードラボは可能です)。

{% YouTube 'yNuCWqATf7U' %}

## Passkey (パスキー) で WebAuthn は次の次元へ

そんなセキュリティとユーザビリティのバランスが取れた FIDO / WebAuthn ですが、問題点もあります。

登録したクレデンシャルが認証器、つまりデバイスに紐付いてしまうということは、新しいデバイスを新しく登録し直す前に、別の方法でログイン (つまりアカウントリカバリー) しないといけない、という点です。これは、いくら FIDO / WebAuthn が強力なセキュリティを提供してくれるとしても、アカウントリカバリーの方法次第で大きな穴を開けてしまうことを意味します。ここで安全なログイン方法が提供できるなら、そもそも FIDO / WebAuthn など必要ないわけで、これを解決することが今後の安全な認証の鍵となる、ということです。

そこで passkey (パスキー) です。パスキーは、プラットフォーム認証器に保存されたクレデンシャル (秘密鍵) をプラットフォームのパスワードマネージャーを通じて、クラウドにバックアップ、もしくは同期してしまおうという FIDO Alliance での取り決めです。ここで言うプラットフォームとは OS なので、例えば macOS、iOS、iPadOS を使っていれば、Chrome も Safari も Edge も iCloud を通じて passkey が保存されます。Android や Chrome OS を使っている場合は Google のパスワードマネージャーを使うことになりますし、Windows であれば (未発表のためおそらく) Microsoft のパスワードマネージャーを使うことになるようです。もちろん End-to-End で暗号化されるので、プラットフォーマーそのものや、ネットワークの経路にいる第三者が passkey を盗むことはできません。

{% Aside %}

"passkey" は当初 [Apple が同名の "Passkeys" として発表した](https://developer.apple.com/videos/play/wwdc2021/10106/)機能ですが、FIDO Alliance の中で、この名前を共通のものとして使おうという取り決めができたようです。ただし、最初の P が大文字の場合は Apple の商標、ということになってるようです。

{% endAside %}

Google も含め、各社まだ実物が出てきていないためはっきりとは言えませんが、ユーザーも開発者も、何も特別なことをしなくても passkey を使い始められるようになるものと思われます。各パスワードマネージャーへのログインは必要となりますが、今時、普通に使っていれば macOS も iPhone も iPad も Android も Windows も、OS にログインする == それぞれのクラウドサービスのオンラインアカウントにログインするため、自動的に登録されたクレデンシャルは passkey として同期されるものと思われます。

ちなみに、デバイスを限定させたいというニーズに応えるため、Device Public Key という 2 つ目の公開鍵ペアを生成する拡張も議論されていますが、これを使う場合はサーバー側に対応したロジックの実装が必要になります。

### Discoverable Credentials

FIDO / WebAuthn には、登録時にログインユーザーの情報を追加する Discoverable Credentials という機能があります。これを使うと、ログイン時にユーザーが自分のユーザー名を入力しなくても、クライアントがアカウントを選択するダイアログを出し、その後ローカル認証を行ってくれるため、ユーザー名を忘れることなく利用できるというメリットがあります。Discoverable Credentials はこれまで Chrome のデスクトップと macOS、iOS、iPadOS の Safari、Windows で提供されてきましたが、passkey 対応に必須となるため、(ようやく) Android でも利用できるようになる予定です。

{% Figure '/images/2022/discoverable-credentials.png', '', '' %}

### caBLE

Passkey の登場で FIDO / WebAuthn はアカウントリカバリーを必要とせず新しいデバイスで安全にログインできるようになります。ただしそれは、同じプラットフォームであれば、の話です。では例えば、普段 Android と macOS を使っているユーザーはどうすればいいのでしょうか？Android に保存した passkey で macOS 上にログインできないのではないでしょうか？

実は、QR コードを使ってログインすることができます。

[Google アカウントにログインする際、Android や iPhone をセキュリティキーとして使える](https://support.google.com/accounts/answer/9289445?hl=ja)のはご存知でしたか？プッシュ通知を使った二段階認証のオプションも利用可能で、体験としては似ているのですが、FIDO のプロトコルで行われるため、フィッシングに強いという特徴があります。

この同じ機能を Google アカウント以外のログインでも利用できるようにしたものが caBLE (cloud-assisted BLE) です。Google アカウントの場合 QR コードなしで使えるのは、端末がログイン状態から自明だからです。プラットフォームを跨ぐ場合、使える端末を QR コードで登録して使う必要があります。

caBLE はすでにデスクトップ版 Chrome で利用可能ですが、passkey 同様、クロスプラットフォームを跨いだ取り決めのため、いずれ Apple や Microsoft のプラットフォームでも利用可能になるはずです。

## 二段階認証

passkey の登場によって、FIDO /WebAuthn はセキュリティとユーザビリティのバランスが取れ、パスワードの必要ないログインを実現することができる、ということがおわかり頂けたでしょうか？

とはいえ、各プラットフォームすべてが passkey を使えるようになるにはまだしばらくかかると思われます。また、対応デバイスやブラウザのことも考えると、実際にパスワードをなくして安心できるようになるのはもっと先のお話、数年から長ければ 5 年以上かかると考えるのが無難だと思います。

では passkey に移行できるまでの間、パスワードによる認証しか提供していないサービス、特に機微な情報やお金を扱うサービスがそのままでいいかというと、そういうわけにはいきません。可能な限り認証を強くする対策、つまり二段階認証を導入すべきです。

二段階認証とは、ユーザー名とパスワードに加え、追加のコードを要求することで、認証の度合いを強めます。追加のコードは一般に OTP (One Time Password) と呼ばれ、メールや SMS、アプリなどから提供されるのが主流です。

### メールを使った二段階認証

予め登録されているメールアドレスに OTP のテキスト、もしくは OTP を渡すリンクが送られます。OTP をコピーして入力する場合、フィッシング詐欺に引っかかってしまう可能性があるので、ユーザーは注意が必要です。その点、リンクをクリックして入力させるタイプであれば、ユーザーが誤ってフィッシングサイトに OTP を入力する可能性は低くなるため、若干安全と言えます。

欠点としては、ユーザーがメールクライアントに切り替えなければならないため、手間と時間がかかります。今の所これを解決するブラウザ API は存在していません。

また、ユーザーの使っているメールサービスが脆弱でアカウントを乗っ取られてしまえば、メールで OTP を送るサービスも道連れになる、むしろそれが狙われる可能性も否定できません。

### SMS OTP を使った二段階認証

予め登録されている電話番号に SMS で OTP のテキストが送られます。ユーザーは SMS アプリを開き、OTP をコピーしてフォームに入力する必要があります。

{% Aside %}

SMS OTP と言うと必ず、NIST 800-63 で推奨されてないからダメだ、電話番号は使い回されるからダメだ、ソーシャルエンジニアリングで乗っ取られるからダメだ、という方がいらっしゃいます。それは全く正しいのですが、脆弱なパスワードを使ったユーザーのアカウントが乗っ取られる可能性と天秤にかけて考えるべきであると考えます。

{% endAside %}

SMS OTP にはフィッシング (SMS に関して言えば[スミッシング](https://ja.wikipedia.org/wiki/%E3%82%B9%E3%83%9F%E3%83%83%E3%82%B7%E3%83%B3%E3%82%B0)という言葉もあるようです) に対しても耐性がありません。とはいえ、補助的にユーザー体験を向上し、セキュリティも幾分改善する API があります。WebOTP API と `autocomplete="one-time-code"` です。前者は Chromium 系のブラウザで、後者は Safari で利用できます。SMS を規定のフォーマットに合わせて送ることで、ユーザーが**指定したドメインを見ている時のみ**ダイアログを表示して、SMS アプリを起動することなく、ブラウザ上でワンタップだけで OTP を入力できるようになります。これはユーザー体験が向上するだけでなく、ユーザーをフィッシングに引っかかりにくくするという意味で、必ず実装してもらいたい機能です。

HTML では OTP を入力する `input` タグに `autocomplete="one-time-code"` を追加します。

```html
<form action="/verify-otp" method="POST">
  <input type="text"
         inputmode="numeric"
         autocomplete="one-time-code"
         pattern="\d{6}"
         required>
</form>
```

WebOTP API を追加するには、下記のコードをコピペします。

```js
// Feature detection
if ('OTPCredential' in window) {
  window.addEventListener('DOMContentLoaded', e => {
    const input = document.querySelector('input[autocomplete="one-time-code"]');
    if (!input) return;
    // フォームが submit されたら WebOTP API をキャンセル
    const ac = new AbortController();
    const form = input.closest('form');
    if (form) {
      form.addEventListener('submit', e => {
        // WebOTP API をアボート
        ac.abort();
      });
    }
    // WebOTP API を実行
    navigator.credentials.get({
      otp: { transport:['sms'] },
      signal: ac.signal
    }).then(otp => {
      input.value = otp.code;
      // OTP を入力後、自動的にフォームを submit
      if (form) form.submit();
    }).catch(err => {
      console.log(err);
    });
  });
}
```

送る SMS には、一番最後の行に `@` で始まるドメインと、`#` で始まる OTP を書きます。

```text
あなたの OTP は 123456 です。

@blog.agektmr.com #123456
```

ちなみに上記は iOS、Android だけでなく、デスクトップでも OTP の入力を補助してくれます。詳しくは [SMS OTP form best practices](https://web.dev/sms-otp-form/) をご覧ください。

完璧とは言いませんが、これで救われるユーザーはいるかもしれません。

### アプリを使った二段階認証

ここで言う「アプリ」とは Google Authenticator ([Android](https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&hl=ja), [iOS](https://apps.apple.com/jp/app/google-authenticator/id388497605)) のような Time-based OTP (TOTP) を提供するものです。(WebAuthn の「認証器」も Authenticator ですが) ここではこういったアプリをオーセンティケーターと呼びます。

予め QR コードで登録しておくと、オーセンティケーターが 30 秒程度で切り替わる OTP を表示してくれます。ユーザーは OTP を求められたらオーセンティケーターを開き、OTP をコピーしてフォームに入力します。

TOTP 自体は RFC のある枯れた標準仕様のため、Google Authenticator の他にも Microsoft Authenticator や、シークレットを同期してくれる 1Password、Authy のようなオーセンティケーターもあり、ユーザーは自由に選ぶことができます。

TOTP の場合でも、ご多分に漏れずフィッシングのリスクが付きまといます。ユーザーが誤ってフィッシングサイトに OTP を入力してしまえば、アカウントは乗っ取られてしまいます。

ライバルに塩を送るようですが、Safari はバージョン 15 以降、この問題への解決策を提供しています。iCloud Keychain に、パスワードだけでなく TOTP も保存できるようにしているため、SMS OTP に使ったのと同じ `autocomplete="one-time-code"` を使うことで、ユーザーは OTP をワンタップで入力することができます。

僕は、これはメールや SMS OTP よりも筋がいいと思っています。なぜなら:

* ユーザーはブラウザを離れることなく OTP を入力できる。
* オリジンに紐付けられているため、フィッシングサイトではサジェストされず安全。
* ブラウザネイティブなので、リテラシの低いユーザーでも使いやすい。

OTP がサジェストされないからといってわざわざ Keychain を開いて入力するようなユーザーであれば、おそらく自分がやっていることの意味が分かっているので、フィッシングには引っかかりにくいだろう、という想定です。

WebOTP API でも TOTP 対応できるようプッシュしてみます。

## ID 連携

自分のサービスでパスワードを作らせない方法としては ID 連携が挙げられます。これは OpenID Connect や OAuth、SAML といった標準プロトコルを使ってサードパーティー (Identity Provider = IdP) に認証を委ねることで、(連携自体に脆弱性が含まれなければ) リスクを外部化することができます。

この場合、自サービスでパスワードを作らせる必要がなくなるとはいえ、実際にはほとんどのサービスがパスワードと併用しているケースが多いというのが現実です。
IdP が強力な認証機能を実現している、少なくともたくさんのセキュリティエンジニアを抱えているというのはポイントになると思います。

ただ、歴史の長い ID 連携とはいえ、完璧とは言えない部分も存在しています。

* IdP はサードパーティー Cookie を使ってユーザーをトラッキングすることができる
* RP は連携してユーザープロファイルを作ることができてしまう
* サードパーティー Cookie がなくなることで ID 連携自体ができなくなってしまう部分がある

### Federated Credential Management API

そこで登場するのが Federated Credential Management API 略して FedCM です。

## まとめ

最後に、ここで書いた話を再度まとめます。

* パスワードだけを使った認証ではユーザーを守りきれない世界になってきている。
* WebAuthn を使うことで、より安全かつスムーズなログイン体験を提供することができる。
* Passkeys が使えるようになれば、パスワードをなくすことができるかもしれない。
* とはいえ移行の間、パスワードは残さざるを得ない。二段階認証でセキュリティを高めるべき。
* ID 連携もすぐに実現できるパスワードレス。今後 Federated Credential Management API がプライバシーも改善してくれるかもしれない。

Cover photo by [olieman.eth](https://unsplash.com/@moneyphotos) on [Unsplash](https://unsplash.com/s/photos/keys)