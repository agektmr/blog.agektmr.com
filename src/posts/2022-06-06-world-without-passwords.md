---
layout: post
title: 'パスワードのない世界に向けて'
description: ''
date: 2022-06-06
image:
  feature: /2021/require-corp.png
tags:
- WebAuthn
- FIDO
- FedCM
- WebOTP
- Passkeys
- Identity
---

ゴール:
- Google I/O のビデオをプロモートする
- パスキーについて知ってもらう
- FedCM について知ってもらう
- WebOTP API について知ってもらう
- 今後認証システムがどうあるべきか知ってもらう

先日 Google I/O で ["A path to a world without passwords"](https://io.google/2022/program/e3bb37a4-2723-4d72-a5b3-1a23abb94ac0/) というセッションを担当しました。

{% YouTube '6vnQDn3AUbo' %}

この記事はパスワードのない世界の実現に向けて、今後どんなことが可能になるのか、それに対してウェブ開発者は何をすべきか、をまとめたものです。先に記事の内容をまとめると以下のものになります:

* パスワードだけを使った認証ではユーザーを守りきれない世界になってきている。
* WebAuthn を使うことで、より安全かつスムーズなログイン体験を提供することができる。
* Passkeys が使えるようになれば、パスワードをなくすことができるかもしれない。
* とはいえ移行の間、パスワードは残さざるを得ない。二段階認証でセキュリティを高めるべき。
* ID 連携もすぐに実現できるパスワードレス。今後 Federated Credential Management API がプライバシーも改善してくれるかもしれない。

<!-- excerpt -->

## なぜパスワードをなくすのか

ウェブでは、ユーザー名とパスワードを使った認証が長らく使われてきました。しかし、パスワードにまつわる問題はあとを絶ちません。システム側の問題として、そもそも脆弱なパスワードしか許容しない仕様であったり、実装が未熟なためにパスワードが漏洩したり。たとえシステムが優れていても、ユーザー側の問題でアカウントが乗っ取られるケースも多くあります。パスワードを推測しやすいものや、複数サイトに跨って同じものを使いまわしてしまうなどです。理想的には各サイトごとに異なる複雑なパスワードを使うべきですが、現実的には難しいと言わざるを得ません。
最近のパスワードマネージャーはパスワードの自動入力や同期してくれるだけでなく、強いパスワードを自動生成したり、脆弱なパスワードを警告したりもしてくれるため安全性は高まりますが、すべてのユーザーが使ってくれるわけではありません。
もちろんユーザーとして、これらをうまく使いこなして安全なインターネットライフを過ごすことは可能ですが、サービス提供者として顧客となるユーザーの安全性を保つとなると、話は全く変わってきます。パスワードを認証手段として使い続けている限り、セキュリティの問題とユーザビリティの問題が一定のラインより良くなることはないと言わざるを得ません。

{% Figure '/images/2022/phishing-is-surging.png', '', 'source: <a href="https://blog.google/intl/en-in/products/platforms/better-password-protections-in-chrome/">https://blog.google/intl/en-in/products/platforms/better-password-protections-in-chrome</a>' %}

それなら、そもそもパスワード以外の方法で安全にユーザーアカウントを管理する方法はないのでしょうか？

## 切り札となる WebAuthn

以前、[パスワードの不要な世界はいかにして実現されるのか](/2019/03/fido-webauthn.html)という記事を書いたので少し内容が被りますが、重要な部分だけ改めて書きます。

WebAuthn は[すべてのメジャーブラウザがサポートする](https://caniuse.com/webauthn)比較的新しいウェブ標準で、ハードウェアベースの公開鍵暗号方式を使い、フィッシングに強い認証を実現します。その仕様は [FIDO Alliance](https://fidoalliance.org/) が中心となり、FIDO2 という枠組みの中で規定されています。

FIDO2 では、セキュリティキーなどの「認証器」と呼ばれるハードウェアデバイスの要件に加え、CTAP2 というクライアントと認証器の通信プロトコルについても規定しています。ブラウザが認証器と通信するための JavaScript API が [WebAuthn](https://webauthn.guide) であり、機能改良を目指し、現在も [W3C で活発に仕様が議論](https://github.com/w3c/webauthn)されています。

{% Figure '/images/2022/security-keys.png', '', 'セキュリティキー' %}

### セキュリティキーの使い方

WebAuthn で認証を行うには事前に登録が必要です。WebAuthn で登録を行おうとすると、USB などでコンピューターに接続されたセキュリティキーが光るので、これをタッチします。これを「セレモニー」といい、物理的な操作を要することでソフトウェアベースの攻撃を防ぎ、所有認証を確実なものにするためです。セレモニーを行うと、セキュリティキーには公開鍵暗号ペアが生成され、秘密鍵はオリジンの情報と合わせて、取り出せない形で安全に認証器内に保管され、公開鍵がクライアントに渡されます。クライアントは公開鍵をサーバーに保存しておきます。

認証時も同様にして、セレモニーが要求されます。セレモニーが成功すると保管されていた秘密鍵を使って署名が発行されるため、サーバーでの検証が成功すれば認証完了、ということになります。ポイントはこの際、オリジンがチェックされるという点です。秘密鍵は予めオリジンと紐付けられているため、仮にユーザーが悪意のあるウェブサイトに誘導されたとしても、認証器が署名を発行しないためフィッシングできない、ということになります。実際、Google のレポート上ではフィッシング耐性 100% だった、という結果が出ています。

{% Figure '/images/2022/phishing-resistant.png', '', 'source: <a href="https://security.googleblog.com/2019/05/new-research-how-effective-is-basic.html">https://security.googleblog.com/2019/05/new-research-how-effective-is-basic.html</a>' %}

もちろん、セキュリティキーが証明できるのは、その認証器がログインしようとしているユーザーの手元にあるらしい (所有認証)、ということだけなので、これをパスワードなどの知識認証と合わせることでより強力なログイン機能とすることができます。これが二段階、二要素認証です。

### プラットフォーム認証器

セキュリティキーでフィッシングに強い認証が実現できることは分かりましたが、じゃあユーザーにセキュリティキーを持ってもらおう、というのはあまり現実的ではない話です。また、パスワードも必要なままです。そこで登場するのが**プラットフォーム認証器**です。プラットフォーム認証器はスマートフォンやコンピューターに埋め込まれたセキュリティチップを活用したもので、対応したデバイスは多くの場合、生体認証の機能も合わせて持っています。

プラットフォーム認証器が画期的なのは、セキュリティキーを新たに購入しなくてもよいだけなく、この生体認証を含めたデバイスのアンロック機能をセキュリティキーで言うセレモニーとすることで、所有認証に加え、生体認証 (もしくは知識認証) の二要素が一度に認証できることにあります。つまり、一段回、二要素認証です。

「生体認証」と言えればひとことで済むので楽なのですが、実際は生体認証を含めたアンロック機能です。例えば指紋認証の場合、指が乾燥していたり怪我したりといった理由で使えなくなる場面は少なくないため、PIN やパターンを使った知識認証が役に立ちます。これは Android に限った話ではなく、macOS や iOS でも同様です。また、生体認証が使えない端末でも PIN やパターンがあればプラットフォーム認証器として使える、というメリットもあります。

知識認証だったらパスワードと変わらないじゃないか！と思いましたか？そんなことはありません。まず決定的に違うのは、PIN やパターンはそのデバイスが手元になければならないため、リモート攻撃が不可能であるという点です。インターネット上で行われるほとんどの攻撃はリモートのため、物理的にそのデバイスにアクセスできなければならないというのは、有効な防御ということになります。

また、PIN やパターンは少なくとも指紋認証よりは安全と考えられています。Android でも iOS でも試行回数が制限されていますし、変更することができます。ちなみに利用できる生体認証は抽象化されているため、指紋認証や顔認証に限定されず、柔軟に対応できるようです。将来的に安全性の高い新しい方式が出てくるといいですね。

{% Aside %}

家族に見られたら困るよね！とか、ターゲット攻撃されるかもしれない！というツッコミをしてくる方がいるのですが、そういう方は FIDO があってもなくても危険な生活をされてると思いますので、ボディガードでも雇われるといいんじゃないかと思います。

{% endAside %}

プラットフォーム認証器を使った認証はすでに身近なところにあります。先日公開した [Yahoo! JAPAN のパスワードレスの取り組みに関する記事](https://web.dev/i18n/ja/yahoo-japan-identity-case-study/)では、電話番号と SMS OTP を使ったログイン方法を主とし、同じデバイスであれば FIDO を使って再認証できる、という体験が紹介されています。PayPal や Google なども部分的に利用可能です。

なお、簡易的な再認証のデモは[ここ](https://webauthn-codelab.glitch.me/)で試すことができます。また、これを実装する[コードラボ](https://developers.google.com/codelabs/webauthn-reauth)が利用できます。実際に試してみると、パスワードや SMS を使った認証方法と比較して、セキュリティとユーザビリティのバランスがよくできた認証方法だと気付くかと思います。

{% YouTube 'yNuCWqATf7U' %}

## Passkey (パスキー) で WebAuthn は次の次元へ

そんなバランスの良い FIDO / WebAuthn ですが、問題点もあります。登録したクレデンシャルが認証器、ひいてはデバイスそのものに紐付いてしまうということは、他のデバイスに移る度に別の方法でログインし直さない限り、WebAuthn は使えなくなってしまう、ということです。これはその「別の方法」が攻撃者に狙われれば、いくら FIDO が強力なセキュリティを提供してくれるとしても大きな穴を開けてしまう、ということを意味します。

~~パスワード認証の場合と同じです。パスワードを忘れたからメールでパスワードをリセットする、ということは、実質的にメールで OTP を送って認証してるのと同じであり、そのメールアカウントが乗っ取られてしまえば終了です。~~

そこで passkey です。プラットフォーム認証器に保存されたクレデンシャル (秘密鍵) をクラウドに同期 (バックアップ) されたものを Passkey (パスキー) と呼びます。passkey は保存された秘密鍵を、プラットフォームのパスワードマネージャーを通じて、クラウドにバックアップ、もしくは同期してしまおうという取り決めです。もちろん End-to-End で暗号化されるので、プラットフォーマーやネットワークの経路にいる第三者が盗むことはできません。


ここで言うプラットフォームとは OS ということになります。例えば macOS を使っていれば Chrome も Safari も Edge も iCloud を通じて passkey が保存されます。iOS や iPadOS も同様。Android や Chrome OS を使っている場合は Google のパスワードマネージャーを使うことになり、Windows であれば Microsoft のパスワードマネージャーを (未発表のためおそらく) 使うことになるようです。

{% Aside %}

"passkey" は当初 Apple が同名の "Passkeys" として発表した機能ですが、FIDO Alliance の中で、この名前を共通のものとして使おうという取り決めができたようです。ただし、最初の P が大文字の場合は Apple の商標、ということになってるようです。

{% endAside %}

各社いずれも実物が出てきていないためまだはっきりとは言えませんが、ユーザーは何も特別なことをする必要はないものと思われます。今時 macOS も iPad も Android も Windows も、OS にログインする == それぞれのクラウドサービスのオンラインアカウントにログインするため、自動的に passkey も同期されるものと思われます。

ちなみに、デバイスを限定させたいというニーズに応えるため、Device Public Key という 2 つ目の公開鍵ペアを生成する仕様も議論されています。

### caBLE

プラットフォームごとに同期すると書きましたが、それでは Android に保存した passkey で macOS 上にログインできないのではないか？と思われるかもしれません。実は、QR コードを使ってログインすることができます。

すでに Google アカウントにログインする際、Android や iPhone をセキュリティキーとして使えるのはご存知でしたか？以前、プッシュ通知を使った二段階認証のオプションは利用可能でしたが、それとは異なります。体験としては似ているのですが、FIDO のプロトコルで行われるため、フィッシングに強いという特徴があります。

Google アカウントにスマートフォンでログインする、というものに QR コードを加えたものがそれです。Google アカウントで QR コードなしで使えるのは、端末が自明だからです。クロスプラットフォームとなると、予め使える端末を登録しなければいけない、という意味で QR コードが必要になります。

この体験を実現しているのは、前回の記事で少し触れた caBLE (Cloud-assisted BLE) です。ログインしようとしている端末が BLE のアドバータイジングパケットが届く範囲かどうかで、物理的に近くにいる必要があるため、リモート攻撃が難しくなります。

### Discoverable Credentials



このように、passkey の登場によって、セキュリティとユーザビリティのバランスが取れたログインが、まもなく

## 二段階認証

各プラットフォーム揃って Passkey が使えるようになるのは来年頃になると思われますが、実際に完全移行できるようになるのはもっと先のお話、数年から長ければ 5 年以上かかるかもしれません。ではその間パスワードによる認証しか提供していないサービスはというと、大きな穴を開けたままということになってしまいます。何かしらのセキュリティ対策をすべきです。

やはり二段階認証ということになります。今できる二段階認証としては
* メール
* SMS
* アプリ
を使ったワンタイムパスワードを発行する方法が考えられます。

### SMS OTP を使った二段階認証

### Time-based OTP を使った二段階認証

これは Google I/O のビデオの中で言わなかったのですが、条件が整えば SMS OTP よりも Time-based OTP の方が筋がいいと考えています。

Time-based OTP というのは,,,

実は Apple さんが Safari 15 からサポート

SMS やメールよりも筋がいい。

マルウェア?

## ID 連携

自分のサービスでパスワードを作らせない方法としては ID 連携が挙げられます。これは OpenID Connect や OAuth、SAML といった標準プロトコルを使ってサードパーティー (Identity Provider = IdP) に認証を委ねることで、(連携自体に脆弱性が含まれなければ) リスクを外部化することができます。

この場合、自サービスでパスワードを作らせる必要がなくなるとはいえ、実際にはほとんどのサービスがパスワードと併用しているケースが多いというのが現実です。
IdP が強力な認証機能を実現している、少なくともたくさんのセキュリティエンジニアを抱えているというのはポイントになると思います。

ただ、歴史の長い ID 連携とはいえ、完璧とは言えない部分も存在しています。

* IdP はサードパーティー Cookie を使ってユーザーをトラッキングすることができる
* RP は連携してユーザープロファイルを作ることができてしまう
* サードパーティー Cookie がなくなることで ID 連携自体ができなくなってしまう部分がある

### Federated Credential Management API

そこで登場するのが Federated Credential Management API 略して FedCM です。

## まとめ

最後に、ここで書いた話を再度まとめます。

* パスワードだけを使った認証ではユーザーを守りきれない世界になってきている。
* WebAuthn を使うことで、より安全かつスムーズなログイン体験を提供することができる。
* Passkeys が使えるようになれば、パスワードをなくすことができるかもしれない。
* とはいえ移行の間、パスワードは残さざるを得ない。二段階認証でセキュリティを高めるべき。
* ID 連携もすぐに実現できるパスワードレス。今後 Federated Credential Management API がプライバシーも改善してくれるかもしれない。
