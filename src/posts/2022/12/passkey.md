---
layout: post
title: 'パスワードの不要な世界はいかにして実現されるのか - パスキーとは何なのか'
description: ''
date: 2022-12-11
tags:
- Passkey
- WebAuthn
- FIDO
- FIDO2
- 認証
- Authentication
---

パスキーはフィッシングに強く、テクノロジーに詳しくないユーザーでも使いやすい新しい認証方式で、いずれパスワードを置き換えると言われています。この記事では、パスキーの基本と、これからのウェブにとってパスキーがどういう意味を持つのかについてまとめてみます。

<!-- excerpt -->

## パスキーとは何か

12 月 9 日に Google が [Android 版 Chrome でパスキーがサポートされたとのアナウンスが出ました](https://blog.chromium.org/2022/12/introducing-passkeys-in-chrome.html)。Apple もすでに[最新版の macOS Ventura、iOS / iPadOS 16 で Safari がパスキーに対応](https://developer.apple.com/videos/play/wwdc2022/10092/)しています。

パスキーは Apple、Google、Microsoft が協調して使う [FIDO クレデンシャル](/2019/03/fido-webauthn.html)の名前です。エンドユーザーのみなさんがパスワードの代わりとして認識し、直感的にログインできるよう「パスキー」というブランドとアイコンが決まりました。ウェブ開発者的には [FIDO Alliance](https://fidoalliance.org/) と W3C の定める [WebAuthn (Web Authentication)](https://w3c.github.io/webauthn) の延長線上にあると考えて差し支えありません。この記事で言う「パスキー」は「FIDO クレデンシャル」と置き換えられます。[FIDO と WebAuthn に関しては以前書いた記事](/2019/03/fido-webauthn.html)がありますので、まだの方はぜひお読み頂ければと思います。

パスキーは、パッと見の体験としては生体認証を使ったログインですが、技術者ならこの裏で何が起きているかを知っておく価値はあると思います。

### ユーザー体験

ユーザーがパスキーでログインするには、サイトごとにパスキーを作成しておく必要があります。

パスキーを作成・登録しようとすると、生体認証ダイアログがポップアップし[ローカル認証](#luv)を行います。認証が完了すると、新しくパスキーが作成されます。

{% YouTube 'lZXGXxZIMTU' %}

ログイン時はアカウントセレクターが表示されるため、使いたいアカウントを選んでをタップするとローカル認証が行われ、ログインが完了します。

{% YouTube '6GMDhF1eQOQ' %}

パスキーは同期されるため、別の端末でも利用することができます。しかし、Android で作ったパスキーは Mac には同期されないため、Mac 上の例えば Safari ではそのパスキーは使えません。しかし、端末を跨いでログインさせることができます。

ログインの際、ブラウザが「他の端末でログイン」のようなメニューを表示するので、これをタップすると QR コードを表示します。それをスマホでスキャンすると、ローカル認証が行われ、完了すると自動的にデスクトップ側のログインも完了します。

{% YouTube '8D84Yosw-Ws' %}

## パスキーの何がパスワードよりも優れているのか

### パスキーはローカルで認証する

パスキーを作ったり、パスキーでログインする際、デバイスのスクリーンロックを使い、解除するのと同じ方法で認証を行います。Android であれば指紋認証、顔認証、もしくは PIN やパターン。iOS / iPadOS であれば Touch ID、Face ID、もしくは パスコード。macOS であれば Touch ID もしくはパスワードで、Windows であれば Windows Hello もしくは PIN です。これはネットワークにクレデンシャルを送らず、ユーザーの使っているデバイス上で行われる認証で、「ローカル認証」と呼ばれます。

パスキー作成時、ローカル認証をトリガーに新しい公開鍵ペアが作られ、秘密鍵はデバイスに、公開鍵はサーバーに送られ保存されます。パスキーはこの秘密鍵とそのメタデータを指します。その後パスキーは同期され、他の端末からでも利用できるという仕組みです。

パスワードであればユーザーの入力した文字列をサーバーに送ることでリモート認証を行うところですが、パスキーのログインではローカル認証をトリガーに署名を生成し、それをサーバーに送ります。サーバーはそのパスキーを作った時に保存していた公開鍵を使って署名を検証し、認証します。

ローカル認証とサーバーでの署名検証で、合計二回認証していますので、パスキーは単体で生体認証 (もしくは知識認証) と所有認証の二要素認証を行っています。パスワードがいらなくなると言われているのはそのためです。パスワードと違い、ユーザーが誤って漏らしてしまったり、再利用したりもできませんし、何よりもフィッシングに強いという点がパスキーの強みです。

### パスキーはデバイス間で同期が可能

パスキーの最も大きな特徴が、デバイス間で同期できる点です。

従来の FIDO では、作られたクレデンシャルは同じデバイスでしか使えませんでした。リモート攻撃ができないという意味で、攻撃者は物理的にターゲットのデバイスにアクセスしない限り、手も足も出せないことになります。しかしこれでは所有者も新しいデバイスに移行する際、クレデンシャルを作ったすべてのアカウントを移行しなければならない、FIDO 以外のフィッシングに弱い方法で新しい端末にログインしなければならない、ユーザーにそれを理解させた上で使わせなければならない、などの問題がありました。パスキーの同期は、そういった問題点をまるっと解決します。

ただし、同期は同じエコシステム内に限られます。「同じエコシステム」とは、Google、Apple、Microsoft を代表とするそれぞれのプラットフォームが持つパスワードマネージャーなどの仕組みを指します。例えば Apple であれば iCloud Keychain を、Google であれば Google Password Manager を介してパスキーが同期されます (Microsoft は 2022 年 12 月現在パスキーの対応を正式に表明していないため不明)。

Apple は垂直統合しているので Apple デバイス以外で Safari は動かず、基本的にはすべて Apple ID を軸に iCloud Keychain で同期されることになります。Google Chrome は Android デバイス間で Google アカウントを軸に Google Password Manager を使って同期します。いずれも他の OS 上ではパスキーの同期は行われません。なお、Google は Apple や Microsoft が同期用の API を利用可能にした時点で、そのエコシステム上を使ってパスキーを同期する予定であることを[表明しています](https://developers.google.com/identity/passkeys/supported-environments#chromes_passkey_support_on_different_operating_systems)。

{% Aside %}

なお、Android は将来的にサードパーティのパスワードマネージャーがパスキーを同期することをサポートするとも表明していますので、1Password などのパスキー対応を表明しているパスワードマネージャーが Android 上で使えるようになる可能性があります。

{% endAside %}

### パスキーでアカウントセレクターが使える

Safari や デスクトップ Chrome では以前から使えていた機能ではありますが、Android が対応したことで、アカウントセレクターの機能がパスキーの使い方の代表的なものとして数えられるようになりました。これは WebAuthn では Discoverable Credentials (旧 [Resident Key](/2019/03/fido-webauthn.html#resident-key)) と呼ばれるもので、パスキーにメタデータとしてユーザー情報を保存することにより、アカウントセレクターの UI を利用可能にします。ユーザーは自分でユーザー名をタイプすることなく、タップとローカル認証だけでログインが可能になります。パスワードどころかユーザー名も忘れてしまうユーザーにとっては、これでユーザビリティは大きく向上します。

### スマホでログインできる

ユーザー体験のところで説明したスマホでログインできる機能です。

Google アカウントでは以前から[スマートフォンをセキュリティキーとして登録し、二要素認証する](https://support.google.com/accounts/answer/9289445?hl=ja)機能がありました。この機能は FIDO 準拠の仕組みで、現在 Google アカウント以外でも利用できるよう拡張されています。それが、QR コードを介して別のブラウザからログインできる機能の正体です。以前 [caBLE](/2019/03/fido-webauthn.html#cable-を使ってスマートフォンを認証器に) と呼ばれていましたが、現在は hybrid に名前が変わっています。

Hybrid は元々標準化を前提に作られていたため、同様の機能はパスキーと同時に Safari に実装されました。これにより、macOS 上の Safari に Android を使ってログインすることも、Windows 上の Chrome に iPhone を使ってログインすることも可能になりました。

{% Aside %}

Google の二段階認証には似た機能があって、[プッシュ通知を送ってログインを許可する](https://support.google.com/accounts/answer/6361026?hl=ja)というものですが、これは独自の仕組みです。

{% endAside %}

## パスキーに関する考察

### プライバシー

「パスキーを登録してください」と生体認証が求められた時、この指紋なり顔なりの情報がどこに行くのか、疑問に思うエンドユーザーは少なくないと思います。特にパスキーが普及し始め、ユーザーが慣れないうちは、指紋の情報や顔の情報をが集められ監視されるかもしれないとか、サービスがハックされて漏れたら悪人の手に渡ってしまう、といった恐怖を感じるのはごく自然なことだと思います。

FIDO では、生体情報は認証器となるデバイスに保存し、サーバーなどに送信してはならないという[きまり](https://fidoalliance.org/wp-content/uploads/FIDO_Authentication_and_GDPR_White_Paper_May2018-1.pdf)がありますので、少なくとも FIDO Certified な認証器を使う限り ([Android はこれに含まれます](https://prtimes.jp/main/html/rd/p/000000008.000037279.html)。iPhone もおそらく含まれますが、ソースを見つけられませんでした。)、これは守られる原則であると考えられますので安心してください。

また、パスキーを作成してサービスに渡される情報は、公開鍵とクレデンシャル ID というどちらもそれ自体意味を持たないバイト列です。クレデンシャル ID は認証する際に使える認証器を制限したり、認証した署名と一致する公開鍵を探す際に使用します。公開鍵は認証時に送られてくる署名を検証するために使われます。どちらもユーザーを特定することはできません。ですので、ユーザーのメールアドレスや名前などの個人情報と組み合わせて登録しない限りは、パスキーからユーザーを特定することはできません。

パスキーは、特に初期はエンドユーザーにとって心理的ハードルが高い認証方法かもしれないので、サービス提供側はそれに寄り添った安心材料をしっかり用意してあげる必要があるのではないかと思います。

### セキュリティ

FIDO は公開鍵暗号方式を使った所有認証が基本です。認証器に物理的にアクセスできない限り、認証を突破するのは難しいというのがポイントでした。ところが、パスキーはこれを同期可能にし、複数端末で利用可能にしました。この点について、[NIST SP800-63B で定義されている AAL3 (Authenticator Assurance Level 3)] から外れてしまうという懸念が挙げられます。

とはいえ、じゃあデバイスと固く紐付いたクレデンシャル以外を認めないと、新しいデバイスに移行する際:

* クレデンシャルを作ったすべてのアカウントを移行しなければならない
* FIDO 以外のフィッシングに弱い方法で新しい端末にログインしなければならない
* ユーザーにそれを理解させた上で使わせなければならない

などの問題があります。利便性が低くフィッシングに弱いデバイスに紐付いた FIDO クレデンシャルと、利便性は高いがリスクが増すパスキーと、どちらを選ぶかという話になります。

ここは使い分けではないかと思います。例えばソーシャルメディアやニュースアプリのような、コンシューマ向けのサービスであれば、アカウントが乗っ取られたとしても経済的被害はそれほど甚大ではないため、パスキーの利便性を取る方が懸命でしょう。逆に機密情報を扱うエンタープライズや、お金を扱う銀行やウォレットアプリなどでは、大きな経済的被害が出る可能性があるため、多少利便性が低くてもデバイスと紐付けておきたいかもしれません。

パスキーとデバイスに紐付いた FIDO クレデンシャルのいいとこ取りをするため、[Device Public Key という Extension](https://w3c.github.io/webauthn/#sctn-device-publickey-extension) が提案されています。これはパスキーと一緒にデバイス特有のもうひとつの公開鍵ペアを作ることで、パスキーがすでに登録されているデバイスかをサーバー上で検知できるようにする仕組みです。これを使えば、パスキーの体験とそう違わない実装で、デバイスに紐付いた FIDO クレデンシャルを使い続けたいというニーズにも応えることができると期待されています。

ただ、現時点で Device Public Key は Android に実装が予定されているものの、Apple デバイスで使えるようになるかは何もアナウンスされていません。Microsoft の動向も含めて、今後に注目です。

---


Apple も Google も (おそらく Microsoft も) 先に解説したとおり、パスキーが漏洩を難しくする工夫をしていますが、どこに落とし穴があるか分かりません。Apple アカウントや Google アカウントが乗っ取られてしまう可能性もゼロではありません。

Apple アカウントや Google アカウントが乗っ取られたら登録してるサービスが一気に全滅するじゃないか！と思った方。たしかにその通りですが、ちょっと待ってください。

1. Apple アカウントや Google アカウントは二段階認証を採用している。

どちらもアカウント管理には世界トップレベルのセキュリティを取り込んでおり、[Apple　も](https://support.apple.com/ja-jp/HT204915#:~:text=%E3%81%BB%E3%81%A8%E3%82%93%E3%81%A9%E3%81%AE%20Apple%20ID%20%E3%81%A7%E3%81%AF,%E3%83%95%E3%82%A1%E3%82%AF%E3%82%BF%E8%AA%8D%E8%A8%BC%E3%81%8C%E5%BF%85%E9%A0%88%E3%81%A7%E3%81%99%E3%80%82) [Google も](https://japan.googleblog.com/2021/05/safer-with-google.html)二段階認証がデフォルトとなっています。

2. アカウントが乗っ取られるリスクを考えるのであれば、問題はすでに広くソーシャルログイン (ID 連携) という形で起こっているはず。

Apple も Goolge も巨大なアイデンティティプロバイダー (IdP) です。すでに広く普及し 10 年以上経つソーシャルログインという手法で、IdP から芋づる式で依存するサービスすべてが乗っ取られた、という話題はあまり聞いたことがありません。おそらく、あったとしても問題として数えられないほどには少ないのではないかと思います。パスキーの場合はこれに加えて、デバイスの PIN やパターンを知らなければならないため、ハードルはさらに上がります。

具体的な数字を知る立場にないので楽観論でしかありませんが、安心材料の一つとしての情報です。

3. アカウントが乗っ取られた場合は、すぐにパスキーを削除できる

アカウントにログインすると、メールか、すでにログインしている端末には通知が飛ぶはずです。身に覚えがなければ、すぐにその端末でのログインを無効にできますし、パスキーを削除することもできます。

パスキーをホストする Apple や Google がこれだけの安全策を施してるとしても、まだ抜け道はあるかもしれません。ただ、それがパスキーを使わずにパスワードを使い続ける理由にはなりません。安全面でも利便性の麺でも、パスワードよりもマシである以上、パスキーを使わない手はない、と個人的には感じます。そもそも完璧なものはそうそうありません。いかのリスク要因を減らせるかがポイントになるため、今現在最大の脅威であるフィッシングに強いというだけでも、パスキーには存在価値があると考えます。

### パスキーの利点

利点としては、ユーザーが深く考えることなく複数端末で安全で簡単にログインできるソリューションが整ったことです。ユーザーはパスワードを覚えなくてよくなり、フィッシングに強いため URL を確認する必要もありませんし、二段階認証という追加の手間を取らなくても生体認証や PIN だけで簡単にログインできます。また、サービスが保存するのは公開鍵なので、パスワードほど漏洩に細心の注意を払わなくてもよくなります。


パスキーを導入してパスワードをなくすことができれば、ユーザーがフィッシング詐欺に引っかかれなくなるし、漏れて困る情報がなくなり、いいことだらけのように思います。しかし、ユーザーがどうしてもパスキーにアクセスできないような状況は、何かしらの形で出てきます。パスキーはまだまだ実装例が少ないため、そういった知見があまりないというのはデメリットのひとつです。

ユーザーがログインできなくなった時のエスケープハッチとして用意された最後の手段を、アカウントリカバリーと呼びます。よくログインフォームにある「パスワードを忘れたら」というリンクがそれです。

パスキーを攻撃するのが難しいとわかれば、アカウントリカバリーが狙われるので、ここをどう守っていくかが重要になります。

その歳、パスキー以外のログイン方法として考えられるのは、パスワードか SMS、もしくはメールでトークンを送る、保存しておいてもらったリカバリーコードを入力してもらう方法などです。パスワードでログインできるままにしてしまうのはユーザーがフィッシングに引っかかるリスクを伴うし、リカバリーコードをちゃんと保存してくれるユーザーがどれほどいるかも疑問が残るため、SMS もしくはメールでトークンを送るのが妥当な解決策でしょうか。

この辺りは今後もベストプラクティスの検証が進んでいくことを期待したいところです。
